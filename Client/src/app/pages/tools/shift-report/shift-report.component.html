<div class="shift-report-container">
  <nz-card nzTitle="Quản lý báo cáo ca">
    <!-- Filter Section -->
    <div class="filter-section">
      <div nz-row [nzGutter]="[16, 16]">
        <!-- Search Input -->
        <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="6">
          <nz-input-group nzSearch [nzAddOnAfter]="suffixIconButton">
            <input
              type="text"
              nz-input
              placeholder="Tìm theo lễ tân"
              [(ngModel)]="searchReceptionist"
              (keyup.enter)="onSearch()" />
          </nz-input-group>
          <ng-template #suffixIconButton>
            <button nz-button nzType="primary" nzSearch (click)="onSearch()">
              <span nz-icon nzType="search"></span>
            </button>
          </ng-template>
        </div>

        <!-- Shift Type Select -->
        <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="6">
          <nz-select
            nzShowSearch
            nzAllowClear
            nzPlaceHolder="Chọn loại ca"
            [(ngModel)]="searchShiftType"
            (ngModelChange)="onSearch()"
            style="width: 100%">
            <nz-option
              *ngFor="let type of shiftTypes"
              [nzLabel]="type"
              [nzValue]="type"></nz-option>
          </nz-select>
        </div>

        <!-- Date Range Picker -->
        <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8" [nzLg]="6">
          <nz-range-picker
            [(ngModel)]="searchDateRange"
            (ngModelChange)="onSearch()"
            nzFormat="yyyy-MM-dd"
            style="width: 100%"></nz-range-picker>
        </div>

        <!-- Action Buttons -->
        <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="24" [nzLg]="6">
          <div class="action-buttons">
            <button nz-button (click)="resetSearch()" style="margin-right: 8px">
              <span nz-icon nzType="reload"></span>
              Làm mới
            </button>
            <button nz-button nzType="primary" (click)="showCreateModal()">
              <span nz-icon nzType="plus"></span>
              Tạo báo cáo
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Table -->
    <nz-table
      #basicTable
      [nzData]="reports"
      [nzLoading]="isLoading"
      [nzTotal]="totalRecords"
      [nzPageSize]="pageSize"
      [nzPageIndex]="pageIndex"
      [nzFrontPagination]="false"
      (nzPageIndexChange)="onPageChange($event)"
      [nzScroll]="{ x: '1200px' }">
      <thead>
        <tr>
          <th nzWidth="50px">STT</th>
          <th nzWidth="100px">Ngày ca</th>
          <th nzWidth="100px">Loại ca</th>
          <th nzWidth="80px">Lễ tân</th>
          <th nzWidth="80px" nzAlign="right">Tiền mặt</th>
          <th nzWidth="80px" nzAlign="right">C.khoản</th>
          <th nzWidth="80px" nzAlign="right">Bàn giao</th>
          <!-- <th nzWidth="150px">Ngày tạo</th> -->
          <th nzWidth="120px" nzAlign="center">Lệnh</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let item of basicTable.data; let i = index">
          <td>{{ (pageIndex - 1) * pageSize + i + 1 }}</td>
          <td>{{ item.ShiftDate | date: 'yyyy-MM-dd' }}</td>
          <td>
            <nz-tag
              [nzColor]="item.ShiftType === 'Ca ngày' ? 'blue' : 'purple'">
              {{ item.ShiftType }}
            </nz-tag>
          </td>
          <td>{{ item.ReceptionistName }}</td>
          <td nzAlign="right">{{ item.TotalCash | number: '1.0-0' }}</td>
          <td nzAlign="right">{{ item.TotalTransfer | number: '1.0-0' }}</td>
          <td nzAlign="right">{{ item.HandoverAmount | number: '1.0-0' }}</td>
          <!-- <td>{{ item.CreatedAt | date: 'yyyy-MM-dd HH:mm' }}</td> -->
          <td nzAlign="center">
            <button
              nz-button
              nzType="default"
              nzSize="small"
              (click)="printReport(item.Id)"
              nz-tooltip="In báo cáo"
              style="margin-right: 8px">
              <span nz-icon nzType="printer" nzTheme="outline"></span>
            </button>
            <button
              nz-button
              nzType="default"
              nzSize="small"
              (click)="exportToExcel(item.Id)"
              nz-tooltip="Xuất Excel"
              style="margin-right: 8px">
              <span nz-icon nzType="file-excel" nzTheme="outline"></span>
            </button>
            <button
              nz-button
              nzType="primary"
              nzSize="small"
              (click)="showEditModal(item.Id)"
              nz-tooltip="Chỉnh sửa"
              style="margin-right: 8px">
              <span nz-icon nzType="edit"></span>
            </button>
            <button
              nz-button
              nzType="primary"
              nzDanger
              nzSize="small"
              (click)="deleteReport(item.Id)"
              nz-tooltip="Xóa">
              <span nz-icon nzType="delete"></span>
            </button>
          </td>
        </tr>
      </tbody>
    </nz-table>
  </nz-card>
  <!-- Modal Form -->
  <nz-modal
    [(nzVisible)]="isModalVisible"
    [nzTitle]="modalTitle"
    [nzCentered]="true"
    [nzWidth]="modalWidth"
    [nzStyle]="modalStyle"
    [nzBodyStyle]="modalBodyStyle"
    (nzOnCancel)="handleCancel()"
    [nzFooter]="modalFooter">
    <ng-container *nzModalContent>
      <form nz-form [formGroup]="reportForm" [nzLayout]="'vertical'">
        <!-- Basic Info -->
        <div nz-row [nzGutter]="[16, 16]">
          <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="12" [nzLg]="6">
            <nz-form-item>
              <nz-form-label nzRequired>Ngày ca</nz-form-label>
              <nz-form-control nzErrorTip="Vui lòng chọn ngày!">
                <nz-date-picker
                  formControlName="shiftDate"
                  nzFormat="yyyy-MM-dd"
                  style="width: 100%"></nz-date-picker>
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="12" [nzLg]="6">
            <nz-form-item>
              <nz-form-label nzRequired>Loại ca</nz-form-label>
              <nz-form-control nzErrorTip="Vui lòng chọn loại ca!">
                <nz-select formControlName="shiftType" style="width: 100%">
                  <nz-option
                    *ngFor="let type of shiftTypes"
                    [nzLabel]="type"
                    [nzValue]="type"></nz-option>
                </nz-select>
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="12" [nzLg]="6">
            <nz-form-item>
              <nz-form-label nzRequired>Giờ bắt đầu</nz-form-label>
              <nz-form-control nzErrorTip="Vui lòng nhập giờ bắt đầu!">
                <nz-date-picker
                  nzShowTime
                  formControlName="startTime"
                  nzFormat="yyyy-MM-dd HH:mm"
                  style="width: 100%"></nz-date-picker>
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="12" [nzLg]="6">
            <nz-form-item>
              <nz-form-label nzRequired>Giờ kết thúc</nz-form-label>
              <nz-form-control nzErrorTip="Vui lòng nhập giờ kết thúc!">
                <nz-date-picker
                  nzShowTime
                  formControlName="endTime"
                  nzFormat="yyyy-MM-dd HH:mm"
                  style="width: 100%"></nz-date-picker>
              </nz-form-control>
            </nz-form-item>
          </div>
        </div>

        <div nz-row [nzGutter]="[16, 16]">
          <div nz-col [nzXs]="24" [nzSm]="24" [nzMd]="12">
            <nz-form-item>
              <nz-form-label nzRequired>Lễ tân (Người giao)</nz-form-label>
              <nz-form-control nzErrorTip="Vui lòng nhập tên lễ tân!">
                <!-- <input
                  nz-input
                  formControlName="receptionistName"
                  placeholder="Nhập tên lễ tân" /> -->

                <nz-select
                  nzShowSearch
                  nzAllowClear
                  formControlName="receptionistName"
                  nzPlaceHolder="Chọn lễ tân trực ca"
                  style="width: 100%">
                  <nz-option
                    *ngFor="let type of receiptors"
                    [nzLabel]="type"
                    [nzValue]="type"></nz-option>
                </nz-select>
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col [nzXs]="24" [nzSm]="24" [nzMd]="12">
            <nz-form-item>
              <nz-form-label>Người nhận</nz-form-label>
              <nz-form-control>
                <!-- <input
                  nz-input
                  formControlName="receiverName"
                  placeholder="Nhập tên người nhận" /> -->
                <nz-select
                  nzShowSearch
                  nzAllowClear
                  formControlName="receiverName"
                  nzPlaceHolder="Chọn lễ tân nhận bàn giao ca"
                  style="width: 100%">
                  <nz-option
                    *ngFor="let type of receiptors"
                    [nzLabel]="type"
                    [nzValue]="type"></nz-option>
                </nz-select>
              </nz-form-control>
            </nz-form-item>
          </div>
        </div>

        <!-- Transactions Section -->
        <nz-divider nzText="Giao dịch trong ca"></nz-divider>

        <div formArrayName="transactions">
          <div class="table-responsive">
            <nz-table
              [nzData]="transactions.controls"
              [nzShowPagination]="false"
              [nzScroll]="{ x: '1400px' }"
              nzSize="small">
              <thead>
                <tr>
                  <th nzWidth="60px">STT</th>
                  <th nzWidth="100px">Số phòng</th>
                  <th nzWidth="100px">Mã phòng</th>
                  <th nzWidth="120px">Loại khách</th>
                  <th nzWidth="140px">Tiền mặt</th>
                  <th nzWidth="140px">Chuyển khoản</th>
                  <th nzWidth="150px">Đặt cọc/TT trước</th>
                  <th nzWidth="200px">ND chi tiêu</th>
                  <th nzWidth="140px">Tiền chi tiêu</th>
                  <th nzWidth="80px">Xóa</th>
                </tr>
              </thead>
              <tbody>
                <tr
                  *ngFor="
                    let transaction of transactions.controls;
                    let i = index
                  "
                  [formGroupName]="i">
                  <td>{{ i + 1 }}</td>
                  <td>
                    <input
                      nz-input
                      (keydown.enter)="$event.preventDefault()"
                      formControlName="roomNumber"
                      placeholder="Số phòng" />
                  </td>
                  <td>
                    <input
                      nz-input
                      (keydown.enter)="$event.preventDefault()"
                      formControlName="invoiceCode"
                      placeholder="Mã hóa đơn của phòng" />
                  </td>
                  <td>
                    <nz-select
                      formControlName="customerType"
                      style="width: 100%"
                      nzAllowClear
                      placeholder="Loại phòng thuê">
                      <nz-option
                        *ngFor="let type of customerTypes"
                        [nzLabel]="type"
                        [nzValue]="type"></nz-option>
                    </nz-select>
                  </td>
                  <td style="position: relative; width: 100%">
                    <nz-input-number
                      placeholder="Tiền mặt"
                      (keydown.enter)="$event.preventDefault()"
                      formControlName="cashAmount"
                      [nzMin]="0"
                      [nzStep]="1000"
                      style="width: 100%"></nz-input-number>

                    <!-- <span
                      *ngIf="!reportForm.get('cashAmount')?.value"
                      style="
                        position: absolute;
                        left: 12px;
                        top: 6px;
                        color: #bfbfbf;
                        pointer-events: none;
                        font-size: 13px;
                      ">
                      Tiền mặt
                    </span> -->
                  </td>
                  <td>
                    <nz-input-number
                      placeholder="Chuyển khoản"
                      (keydown.enter)="$event.preventDefault()"
                      formControlName="transferAmount"
                      [nzMin]="0"
                      [nzStep]="1000"
                      style="width: 100%"></nz-input-number>
                  </td>
                  <td>
                    <input
                      (keydown.enter)="$event.preventDefault()"
                      nz-input
                      formControlName="prepaidNote"
                      placeholder="Đtt ca trước, free, ..." />
                  </td>
                  <td>
                    <input
                      (keydown.enter)="$event.preventDefault()"
                      nz-input
                      formControlName="expenseDescription"
                      placeholder="ND chi tiêu" />
                  </td>
                  <td>
                    <nz-input-number
                      placeholder="Số tiền chi tiêu"
                      (keydown.enter)="$event.preventDefault()"
                      formControlName="expenseAmount"
                      [nzMin]="0"
                      [nzStep]="1000"
                      style="width: 100%"></nz-input-number>
                  </td>
                  <td>
                    <button
                      nz-button
                      nzType="text"
                      nzDanger
                      (click)="removeTransaction(i)"
                      [disabled]="transactions.length === 1">
                      <span nz-icon nzType="delete"></span>
                    </button>
                  </td>
                </tr>
              </tbody>
            </nz-table>
          </div>

          <button
            nz-button
            nzType="dashed"
            (click)="addTransaction()"
            style="width: 100%; margin-top: 8px">
            <span nz-icon nzType="plus"></span>
            Thêm giao dịch
          </button>
        </div>

        <!-- Summary -->
        <nz-card nzTitle="Tổng kết" style="margin-top: 16px" nzSize="small">
          <div nz-row [nzGutter]="[16, 16]">
            <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="12" [nzLg]="6">
              <nz-statistic
                [nzValue]="formatCurrency(calculateTotals().totalCash)"
                [nzTitle]="'Tổng tiền mặt'"
                [nzSuffix]="'đ'"></nz-statistic>
            </div>
            <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="12" [nzLg]="6">
              <nz-statistic
                [nzValue]="formatCurrency(calculateTotals().totalTransfer)"
                [nzTitle]="'Tổng chuyển khoản'"
                [nzSuffix]="'đ'"></nz-statistic>
            </div>
            <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="12" [nzLg]="6">
              <nz-statistic
                [nzValue]="formatCurrency(calculateTotals().totalExpense)"
                [nzTitle]="'Tổng chi tiêu'"
                [nzSuffix]="'đ'"></nz-statistic>
            </div>
            <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="12" [nzLg]="6">
              <nz-statistic
                [nzValue]="formatCurrency(calculateTotals().handoverAmount)"
                [nzTitle]="'Số tiền bàn giao'"
                [nzSuffix]="'đ'"
                [nzValueStyle]="{ color: '#3f8600' }"></nz-statistic>
            </div>
          </div>
        </nz-card>

        <!-- Room Sales Section -->
        <nz-divider nzText="Bàn phòng ngày"></nz-divider>

        <div formArrayName="roomSales">
          <div class="table-responsive">
            <nz-table
              [nzData]="roomSales.controls"
              [nzShowPagination]="false"
              [nzNoResult]="' '"
              nzSize="small">
              <thead>
                <tr>
                  <th nzWidth="60px">STT</th>
                  <th nzWidth="150px">Số phòng</th>
                  <th nzWidth="200px">Loại khách</th>
                  <th nzWidth="170px">Đơn giá</th>
                  <th nzWidth="80px">Xóa</th>
                </tr>
              </thead>
              <tbody>
                <tr
                  *ngFor="let sale of roomSales.controls; let i = index"
                  [formGroupName]="i">
                  <td>{{ i + 1 }}</td>
                  <td>
                    <input
                      (keydown.enter)="$event.preventDefault()"
                      nz-input
                      formControlName="roomNumber"
                      placeholder="Số phòng" />
                  </td>
                  <td>
                    <nz-select
                      formControlName="roomCategory"
                      style="width: 100%">
                      <nz-option
                        *ngFor="let cat of roomCategories"
                        [nzLabel]="cat"
                        [nzValue]="cat"></nz-option>
                    </nz-select>
                  </td>
                  <td>
                    <nz-input-number
                      (keydown.enter)="$event.preventDefault()"
                      formControlName="unitPrice"
                      [nzMin]="0"
                      [nzStep]="10000"
                      style="width: 100%"></nz-input-number>
                  </td>
                  <td>
                    <button
                      nz-button
                      nzType="text"
                      nzDanger
                      (click)="removeRoomSale(i)">
                      <span nz-icon nzType="delete"></span>
                    </button>
                  </td>
                </tr>
              </tbody>
            </nz-table>
          </div>

          <button
            nz-button
            nzType="dashed"
            (click)="addRoomSale()"
            style="width: 100%">
            <span nz-icon nzType="plus"></span>
            Thêm phòng
          </button>
        </div>
      </form>
    </ng-container>

    <ng-template #modalFooter>
      <div class="modal-footer-responsive">
        <button nz-button nzType="default" (click)="handleCancel()">Hủy</button>
        <button
          nz-button
          nzType="primary"
          (click)="handleSubmit()"
          [nzLoading]="isLoading">
          {{ editingId ? 'Cập nhật' : 'Tạo mới' }}
        </button>
      </div>
    </ng-template>
  </nz-modal>
</div>
