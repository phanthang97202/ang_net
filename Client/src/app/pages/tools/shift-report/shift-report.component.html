<div class="shift-report-container">
  <nz-card nzTitle="Quản lý báo cáo ca">
    <!-- Filter Section -->
    <div class="filter-section">
      <div nz-row [nzGutter]="16">
        <div nz-col [nzSpan]="6">
          <nz-input-group nzSearch [nzAddOnAfter]="suffixIconButton">
            <input
              type="text"
              nz-input
              placeholder="Tìm theo lễ tân"
              [(ngModel)]="searchReceptionist"
              (keyup.enter)="onSearch()" />
          </nz-input-group>
          <ng-template #suffixIconButton>
            <button nz-button nzType="primary" nzSearch (click)="onSearch()">
              <span nz-icon nzType="search"></span>
            </button>
          </ng-template>
        </div>

        <div nz-col [nzSpan]="6">
          <nz-select
            nzShowSearch
            nzAllowClear
            nzPlaceHolder="Chọn loại ca"
            [(ngModel)]="searchShiftType"
            (ngModelChange)="onSearch()"
            style="width: 100%">
            <nz-option
              *ngFor="let type of shiftTypes"
              [nzLabel]="type"
              [nzValue]="type"></nz-option>
          </nz-select>
        </div>

        <div nz-col [nzSpan]="6">
          <nz-range-picker
            [(ngModel)]="searchDateRange"
            (ngModelChange)="onSearch()"
            nzFormat="dd/MM/yyyy"
            style="width: 100%"></nz-range-picker>
        </div>

        <div nz-col [nzSpan]="6">
          <button nz-button (click)="resetSearch()" style="margin-right: 8px">
            <span nz-icon nzType="reload"></span>
            Làm mới
          </button>
          <button nz-button nzType="primary" (click)="showCreateModal()">
            <span nz-icon nzType="plus"></span>
            Tạo báo cáo
          </button>
        </div>
      </div>
    </div>

    <!-- Table -->
    <nz-table
      #basicTable
      [nzData]="reports"
      [nzLoading]="isLoading"
      [nzTotal]="totalRecords"
      [nzPageSize]="pageSize"
      [nzPageIndex]="pageIndex"
      [nzFrontPagination]="false"
      (nzPageIndexChange)="onPageChange($event)"
      [nzScroll]="{ x: '1200px' }">
      <thead>
        <tr>
          <th nzWidth="80px">STT</th>
          <th nzWidth="120px">Ngày ca</th>
          <th nzWidth="100px">Loại ca</th>
          <th nzWidth="150px">Lễ tân</th>
          <th nzWidth="120px" nzAlign="right">Tiền mặt</th>
          <th nzWidth="120px" nzAlign="right">Chuyển khoản</th>
          <th nzWidth="120px" nzAlign="right">Bàn giao</th>
          <th nzWidth="150px">Ngày tạo</th>
          <th nzWidth="180px" nzAlign="center">Thao tác</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let item of basicTable.data; let i = index">
          <td>{{ (pageIndex - 1) * pageSize + i + 1 }}</td>
          <td>{{ item.shiftDate | date: 'dd/MM/yyyy' }}</td>
          <td>
            <nz-tag
              [nzColor]="item.shiftType === 'Ca ngày' ? 'blue' : 'purple'">
              {{ item.shiftType }}
            </nz-tag>
          </td>
          <td>{{ item.receptionistName }}</td>
          <td nzAlign="right">{{ item.totalCash | number: '1.0-0' }}</td>
          <td nzAlign="right">{{ item.totalTransfer | number: '1.0-0' }}</td>
          <td nzAlign="right">{{ item.handoverAmount | number: '1.0-0' }}</td>
          <td>{{ item.createdAt | date: 'dd/MM/yyyy HH:mm' }}</td>
          <td nzAlign="center">
            <button
              nz-button
              nzType="default"
              nzSize="small"
              (click)="printReport(item.id)"
              nz-tooltip="In báo cáo"
              style="margin-right: 8px">
              <span nz-icon nzType="printer" nzTheme="outline"></span>
            </button>
            <button
              nz-button
              nzType="default"
              nzSize="small"
              (click)="exportToExcel(item.id)"
              nz-tooltip="Xuất Excel"
              style="margin-right: 8px">
              <span nz-icon nzType="file-excel" nzTheme="outline"></span>
            </button>
            <button
              nz-button
              nzType="primary"
              nzSize="small"
              (click)="showEditModal(item.id)"
              nz-tooltip="Chỉnh sửa"
              style="margin-right: 8px">
              <span nz-icon nzType="edit"></span>
            </button>
            <button
              nz-button
              nzType="primary"
              nzDanger
              nzSize="small"
              (click)="deleteReport(item.id)"
              nz-tooltip="Xóa">
              <span nz-icon nzType="delete"></span>
            </button>
          </td>
        </tr>
      </tbody>
    </nz-table>
  </nz-card>

  <!-- Modal Form -->
  <nz-modal
    [(nzVisible)]="isModalVisible"
    [nzTitle]="modalTitle"
    [nzCentered]="true"
    [nzWidth]="'98%'"
    [nzStyle]="{ top: '5px', height: '95vh' }"
    [nzBodyStyle]="{ 'max-height': 'calc(95vh - 110px)', 'overflow-y': 'auto' }"
    (nzOnCancel)="handleCancel()"
    [nzFooter]="modalFooter">
    <ng-container *nzModalContent>
      <form nz-form [formGroup]="reportForm" [nzLayout]="'vertical'">
        <!-- Basic Info -->
        <div nz-row [nzGutter]="16">
          <div nz-col [nzSpan]="6">
            <nz-form-item>
              <nz-form-label nzRequired>Ngày ca</nz-form-label>
              <nz-form-control nzErrorTip="Vui lòng chọn ngày!">
                <nz-date-picker
                  formControlName="shiftDate"
                  nzFormat="dd/MM/yyyy"
                  style="width: 100%"></nz-date-picker>
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col [nzSpan]="6">
            <nz-form-item>
              <nz-form-label nzRequired>Loại ca</nz-form-label>
              <nz-form-control nzErrorTip="Vui lòng chọn loại ca!">
                <nz-select formControlName="shiftType" style="width: 100%">
                  <nz-option
                    *ngFor="let type of shiftTypes"
                    [nzLabel]="type"
                    [nzValue]="type"></nz-option>
                </nz-select>
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col [nzSpan]="6">
            <nz-form-item>
              <nz-form-label nzRequired>Giờ bắt đầu</nz-form-label>
              <nz-form-control nzErrorTip="Vui lòng nhập giờ bắt đầu!">
                <nz-time-picker
                  formControlName="startTime"
                  nzFormat="HH:mm"
                  style="width: 100%"></nz-time-picker>
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col [nzSpan]="6">
            <nz-form-item>
              <nz-form-label nzRequired>Giờ kết thúc</nz-form-label>
              <nz-form-control nzErrorTip="Vui lòng nhập giờ kết thúc!">
                <nz-time-picker
                  formControlName="endTime"
                  nzFormat="HH:mm"
                  style="width: 100%"></nz-time-picker>
              </nz-form-control>
            </nz-form-item>
          </div>
        </div>

        <div nz-row [nzGutter]="16">
          <div nz-col [nzSpan]="12">
            <nz-form-item>
              <nz-form-label nzRequired>Lễ tân (Người giao)</nz-form-label>
              <nz-form-control nzErrorTip="Vui lòng nhập tên lễ tân!">
                <input
                  nz-input
                  formControlName="receptionistName"
                  placeholder="Nhập tên lễ tân" />
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col [nzSpan]="12">
            <nz-form-item>
              <nz-form-label>Người nhận</nz-form-label>
              <nz-form-control>
                <input
                  nz-input
                  formControlName="receiverName"
                  placeholder="Nhập tên người nhận" />
              </nz-form-control>
            </nz-form-item>
          </div>
        </div>

        <!-- Transactions Section -->
        <nz-divider nzText="Giao dịch trong ca"></nz-divider>

        <div formArrayName="transactions">
          <div class="table-responsive">
            <nz-table
              [nzData]="transactions.controls"
              [nzShowPagination]="false"
              [nzScroll]="{ x: '1400px' }"
              nzSize="small">
              <thead>
                <tr>
                  <th nzWidth="60px">STT</th>
                  <th nzWidth="100px">Số phòng</th>
                  <th nzWidth="100px">Mã phòng</th>
                  <th nzWidth="120px">Loại khách</th>
                  <th nzWidth="120px">Tiền mặt</th>
                  <th nzWidth="120px">Chuyển khoản</th>
                  <th nzWidth="150px">Đặt cọc/TT trước</th>
                  <th nzWidth="200px">ND chi tiêu</th>
                  <th nzWidth="120px">Tiền chi tiêu</th>
                  <th nzWidth="80px">Xóa</th>
                </tr>
              </thead>
              <tbody>
                <tr
                  *ngFor="
                    let transaction of transactions.controls;
                    let i = index
                  "
                  [formGroupName]="i">
                  <td>{{ i + 1 }}</td>
                  <td>
                    <input
                      nz-input
                      formControlName="roomNumber"
                      placeholder="201" />
                  </td>
                  <td>
                    <input
                      nz-input
                      formControlName="invoiceCode"
                      placeholder="6786" />
                  </td>
                  <td>
                    <nz-select
                      formControlName="customerType"
                      style="width: 100%"
                      nzAllowClear>
                      <nz-option
                        *ngFor="let type of customerTypes"
                        [nzLabel]="type"
                        [nzValue]="type"></nz-option>
                    </nz-select>
                  </td>
                  <td>
                    <nz-input-number
                      formControlName="cashAmount"
                      [nzMin]="0"
                      [nzStep]="1000"
                      style="width: 100%"></nz-input-number>
                  </td>
                  <td>
                    <nz-input-number
                      formControlName="transferAmount"
                      [nzMin]="0"
                      [nzStep]="1000"
                      style="width: 100%"></nz-input-number>
                  </td>
                  <td>
                    <input
                      nz-input
                      formControlName="prepaidNote"
                      placeholder="đtt ca trước" />
                  </td>
                  <td>
                    <input
                      nz-input
                      formControlName="expenseDescription"
                      placeholder="Mô tả" />
                  </td>
                  <td>
                    <nz-input-number
                      formControlName="expenseAmount"
                      [nzMin]="0"
                      [nzStep]="1000"
                      style="width: 100%"></nz-input-number>
                  </td>
                  <td>
                    <button
                      nz-button
                      nzType="text"
                      nzDanger
                      (click)="removeTransaction(i)"
                      [disabled]="transactions.length === 1">
                      <span nz-icon nzType="delete"></span>
                    </button>
                  </td>
                </tr>
              </tbody>
            </nz-table>
          </div>

          <button
            nz-button
            nzType="dashed"
            (click)="addTransaction()"
            style="width: 100%; margin-top: 8px">
            <span nz-icon nzType="plus"></span>
            Thêm giao dịch
          </button>
        </div>

        <!-- Summary -->
        <nz-card nzTitle="Tổng kết" style="margin-top: 16px" nzSize="small">
          <div nz-row [nzGutter]="16">
            <div nz-col [nzSpan]="6">
              <nz-statistic
                [nzValue]="calculateTotals().totalCash"
                [nzTitle]="'Tổng tiền mặt'"
                [nzSuffix]="'đ'"></nz-statistic>
            </div>
            <div nz-col [nzSpan]="6">
              <nz-statistic
                [nzValue]="calculateTotals().totalTransfer"
                [nzTitle]="'Tổng chuyển khoản'"
                [nzSuffix]="'đ'"></nz-statistic>
            </div>
            <div nz-col [nzSpan]="6">
              <nz-statistic
                [nzValue]="calculateTotals().totalExpense"
                [nzTitle]="'Tổng chi tiêu'"
                [nzSuffix]="'đ'"></nz-statistic>
            </div>
            <div nz-col [nzSpan]="6">
              <nz-statistic
                [nzValue]="calculateTotals().handoverAmount"
                [nzTitle]="'Số tiền bàn giao'"
                [nzSuffix]="'đ'"
                [nzValueStyle]="{ color: '#3f8600' }"></nz-statistic>
            </div>
          </div>
        </nz-card>

        <!-- Room Sales Section -->
        <nz-divider nzText="Bàn phòng ngày"></nz-divider>

        <div formArrayName="roomSales">
          <nz-table
            [nzData]="roomSales.controls"
            [nzShowPagination]="false"
            nzSize="small">
            <thead>
              <tr>
                <th nzWidth="80px">STT</th>
                <th nzWidth="200px">Số phòng</th>
                <th nzWidth="200px">Loại khách</th>
                <th nzWidth="200px">Đơn giá</th>
                <th nzWidth="80px">Xóa</th>
              </tr>
            </thead>
            <tbody>
              <tr
                *ngFor="let sale of roomSales.controls; let i = index"
                [formGroupName]="i">
                <td>{{ i + 1 }}</td>
                <td>
                  <input
                    nz-input
                    formControlName="roomNumber"
                    placeholder="501" />
                </td>
                <td>
                  <nz-select formControlName="roomCategory" style="width: 100%">
                    <nz-option
                      *ngFor="let cat of roomCategories"
                      [nzLabel]="cat"
                      [nzValue]="cat"></nz-option>
                  </nz-select>
                </td>
                <td>
                  <nz-input-number
                    formControlName="unitPrice"
                    [nzMin]="0"
                    [nzStep]="10000"
                    style="width: 100%"></nz-input-number>
                </td>
                <td>
                  <button
                    nz-button
                    nzType="text"
                    nzDanger
                    (click)="removeRoomSale(i)">
                    <span nz-icon nzType="delete"></span>
                  </button>
                </td>
              </tr>
            </tbody>
          </nz-table>

          <button
            nz-button
            nzType="dashed"
            (click)="addRoomSale()"
            style="width: 100%; margin-top: 8px">
            <span nz-icon nzType="plus"></span>
            Thêm phòng
          </button>
        </div>
      </form>
    </ng-container>

    <ng-template #modalFooter>
      <button nz-button nzType="default" (click)="handleCancel()">Hủy</button>
      <button
        nz-button
        nzType="primary"
        (click)="handleSubmit()"
        [nzLoading]="isLoading">
        {{ editingId ? 'Cập nhật' : 'Tạo mới' }}
      </button>
    </ng-template>
  </nz-modal>
</div>
